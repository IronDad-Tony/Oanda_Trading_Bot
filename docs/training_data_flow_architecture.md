# 訓練資料流與梯度流架構圖

```mermaid
graph LR
    %% [上述Mermaid圖代碼]
```

## 訓練資料流（實線箭頭）
1. **市場數據加載**：
   - 從數據管理層加載OHLC歷史數據
   - 通過`CurrencyDependencyManager`處理貨幣轉換

2. **環境狀態生成**：
   - 環境整合市場數據生成狀態向量
   - 包含技術指標、倉位信息和市場特徵

3. **代理決策過程**：
   - 狀態向量輸入特徵提取器（Transformer編碼器）
   - 策略網絡生成動作（各交易品種倉位比例）
   - 高級整合系統優化決策

4. **獎勵計算**：
   - 環境執行動作後計算風險調整回報
   - 考慮交易成本、波動率調整

## 梯度流動路徑（虛線箭頭）
1. **反向傳播起點**：
   - Critic網絡計算TD誤差
   $$L_{critic} = \mathbb{E}[(Q(s,a) - (r + \gamma Q_{target}(s',a')))^2]$$

2. **策略梯度計算**：
   - Actor網絡更新方向：
   $$\nabla_\phi J(\phi) = \mathbb{E}[\nabla_a Q(s,a) \nabla_\phi \pi_\phi(s)]$$

3. **特徵提取器更新**：
   - 接收來自策略網絡的梯度
   - 通過多頭注意力機制傳播

4. **元學習優化**：
   - 在內循環快速適應市場狀態
   - 外循環優化模型初始化參數
   $$\theta^* = \theta - \alpha \nabla_\theta L_{\tau_i}(f_\theta)$$